<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채팅 메시지</title>
</head>
<body>

<h1>채팅 메시지 보내기</h1>

<!-- UUID는 서버에서 Thymeleaf로 주입하거나, JS로 세팅 -->
<input type="hidden" id="userId" th:value="${userId}">
<input type="hidden" id="serverId" th:value="${serverId}">
<input type="hidden" id="channelId" th:value="${channelId}">

<form id="messageForm" enctype="multipart/form-data">
    <label>메시지 내용:</label><br>
    <textarea id="text" name="text" rows="4" cols="50" required></textarea><br><br>

    <label>첨부 파일 (선택):</label>
    <input type="file" id="profileImage" name="profileImage" multiple><br><br>

    <button type="submit">메시지 전송</button>
</form>

<br><br>
<a th:href="@{/users/{userId}/servers/{serverId}(userId=${userId}, serverId=${serverId})}">
    ← 채널 목록으로 돌아가기
</a>

<hr>

<h2>채널 메시지 목록</h2>
<ul id="messageList"></ul>

<script>
    document.getElementById("messageForm").addEventListener("submit", function (event) {
        event.preventDefault();

        const userId = document.getElementById("userId").value;
        const serverId = document.getElementById("serverId").value;
        const channelId = document.getElementById("channelId").value;
        const text = document.getElementById("text").value;
        const files = document.getElementById("profileImage").files;

        const formData = new FormData();
        formData.append("message", new Blob([JSON.stringify({
            userId: userId,
            channelId: channelId,
            text: text
        })], {type: "application/json"}));

        for (let i = 0; i < files.length; i++) {
            formData.append("profileImage", files[i]);
        }

        fetch(`/api/servers/${serverId}/channels/${channelId}/messages/write`, {
            method: "POST",
            body: formData
        })
            .then(res => {
                if (!res.ok) throw new Error("메시지 전송 실패");
                return res.json();
            })
            .then(data => {
                alert("메시지 전송 완료!");
                document.getElementById("messageForm").reset();
                loadMessages();
            })
            .catch(err => {
                console.error("에러:", err);
                alert("메시지 전송 중 오류 발생");
            });
    });

    function loadMessages() {
        const serverId = document.getElementById("serverId").value;
        const channelId = document.getElementById("channelId").value;

        fetch(`/api/servers/${serverId}/channels/${channelId}/messages`)
            .then(res => res.json())
            .then(data => {
                const list = document.getElementById("messageList");
                list.innerHTML = '';
                data.messages.forEach(msg => {
                    const li = document.createElement("li");
                    li.innerHTML = `<strong>${msg.userName}</strong>: ${msg.text} <br><small>${new Date(msg.createdAt).toLocaleString()}</small>`;
                    list.appendChild(li);
                });
            })
            .catch(err => {
                console.error("메시지 불러오기 실패:", err);
                alert("메시지를 불러오지 못했습니다.");
            });
    }

    document.addEventListener("DOMContentLoaded", loadMessages);
</script>

</body>
</html>
