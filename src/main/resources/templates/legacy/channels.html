<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채널 목록</title>
</head>
<body>

<h1>채널 목록</h1>

<p>유저 ID: <span th:text="${userId}" id="userIdText"></span></p>
<p>서버 ID: <span th:text="${serverId}" id="serverIdText"></span></p>

<table border="1">
    <thead>
    <tr>
        <th>채널 ID</th>
        <th>이름</th>
        <th>참여 유저 수</th>
        <th>마지막 메시지</th>
    </tr>
    </thead>
    <tbody id="channelTableBody">
    <!-- JS로 채널 목록 삽입 예정 -->
    </tbody>
</table>

<br>
<a id="createChannelLink" href="#">
    <button>➕ 채널 생성하기</button>
</a><br><br>
<a href="/users">← 유저 목록으로</a>

<script>
    function getIds() {
        return {
            userId: document.getElementById("userIdText").textContent.trim(),
            serverId: document.getElementById("serverIdText").textContent.trim()
        };
    }

    function setCreateChannelLink() {
        const { userId, serverId } = getIds();
        const link = document.getElementById("createChannelLink");
        link.href = `/users/${userId}/servers/${serverId}/create`;
    }

    function loadChannels() {
        const { userId, serverId } = getIds();  // ✅ 여기서 가져오고

        fetch(`/api/servers/${serverId}/channels`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById("channelTableBody");
                tbody.innerHTML = '';

                data.channels.forEach(channel => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                    <td>${channel.channelId}</td>
                    <td>
                      <a href="/users/${userId}/servers/${serverId}/channels/${channel.channelId}/messages">
                        ${channel.name || '(비공개 채널)'}
                      </a>
                    </td>
                    <td>${channel.userIdList ? channel.userIdList.length : 0}명</td>
                    <td>${channel.lastMessageAt ? new Date(channel.lastMessageAt).toLocaleString() : '-'}</td>
                `;
                    tbody.appendChild(row);
                });
            })
            .catch(err => {
                console.error("채널 목록 불러오기 실패:", err);
                alert("채널 목록을 불러오지 못했습니다.");
            });
    }


    document.addEventListener("DOMContentLoaded", () => {
        setCreateChannelLink();
        loadChannels();
    });
</script>

</body>
</html>
