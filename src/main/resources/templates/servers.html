<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>전체 서버 목록</title>
</head>
<body>

<h1>전체 서버 목록</h1>

<table border="1">
  <thead>
  <tr>
    <th>서버 ID</th>
    <th>서버 이름</th>
    <th>생성일</th>
    <th>수정일</th>
    <th>참여</th> <!-- ✅ 추가 -->
  </tr>
  </thead>
  <tbody id="serverTableBody">
  <!-- JS로 서버 목록 추가 -->
  </tbody>
</table>

<a id="back-link">← 서버 관리 페이지로</a>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("token");

  async function loadServers() {
    if (!token) {
      alert("토큰이 없습니다. 다시 로그인해주세요.");
      window.location.href = "/login";
      return;
    }

    try {
      const response = await fetch("/api/servers", {
        headers: {
          "Authorization": "Bearer " + token
        }
      });

      if (!response.ok) {
        throw new Error("서버 목록 조회 실패");
      }

      const data = await response.json();
      const tableBody = document.getElementById("serverTableBody");
      tableBody.innerHTML = '';

      data.servers.forEach(server => {
        const row = document.createElement("tr");
        row.innerHTML = `
              <td>${server.id}</td>
              <td>${server.name}</td>
              <td>${new Date(server.createdAt).toLocaleString()}</td>
              <td>${new Date(server.updatedAt).toLocaleString()}</td>
              <td>
                <button onclick="joinServer('${server.id}')">참여</button>
              </td>
            `;
        tableBody.appendChild(row);
      });
    } catch (err) {
      console.error("에러:", err);
      alert("서버 목록을 불러오지 못했습니다.");
    }
  }

  async function joinServer(serverId) {
    if (!token) {
      alert("토큰이 없습니다. 로그인해주세요.");
      return;
    }

    try {
      const res = await fetch(`/api/servers/${serverId}/join`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token
        }
      });

      if (!res.ok) {
        throw new Error("서버 참여 실패");
      }

      alert("서버에 참여했습니다!");
      // window.location.href = `/servers/${serverId}/channelList?token=${encodeURIComponent(token)}`;
      window.location.href = `/channel-index?token=${encodeURIComponent(
          token)}&serverId=${serverId}`;
    } catch (err) {
      console.error("참여 에러:", err);
      alert("참여 중 오류가 발생했습니다.");
    }
  }

  document.addEventListener("DOMContentLoaded", loadServers);

  document.addEventListener("DOMContentLoaded", function () {
    // ✅ 링크에 토큰 붙이기
    const backLink = document.getElementById("back-link");
    backLink.href = `/server-index?token=${encodeURIComponent(token)}`;
  });
</script>

</body>
</html>
