<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채팅 메시지</title>
</head>
<body>

<h1>채팅 메시지 보내기</h1>

<input type="hidden" id="userId" value="<!-- 사용자 UUID -->">
<input type="hidden" id="serverId" value="<!-- 서버 UUID -->">
<input type="hidden" id="channelId" value="<!-- 채널 UUID -->">

<form id="messageForm" enctype="multipart/form-data">
    <label>메시지 내용:</label><br>
    <textarea id="text" name="text" rows="4" cols="50" required></textarea><br><br>

    <label>첨부 파일 (선택):</label>
    <input type="file" id="profileImage" name="profileImage" multiple><br><br>

    <button type="submit">메시지 전송</button>
</form>

<hr>

<h2>채널 메시지 목록</h2>
<ul id="messageList"></ul>

<script>
    document.getElementById("messageForm").addEventListener("submit", function(event) {
        event.preventDefault();

        const userId = document.getElementById("userId").value;
        const serverId = document.getElementById("serverId").value;
        const channelId = document.getElementById("channelId").value;
        const text = document.getElementById("text").value;
        const files = document.getElementById("profileImage").files;

        const formData = new FormData();
        formData.append("message", new Blob([JSON.stringify({
            userId: userId,
            channelId: channelId,
            text: text
        })], { type: "application/json" }));

        for (let i = 0; i < files.length; i++) {
            formData.append("profileImage", files[i]);
        }

        fetch(`/api/servers/${serverId}/channels/${channelId}/messages/write`, {
            method: "POST",
            body: formData
        })
            .then(res => {
                if (!res.ok) throw new Error("메시지 전송 실패");
                return res.json();
            })
            .then(data => {
                alert("메시지 전송 완료!");
                loadMessages();
                document.getElementById("messageForm").reset();
            })
            .catch(err => {
                console.error("에러:", err);
                alert("메시지 전송 중 오류 발생");
            });
    });

    function loadMessages() {
        const channelId = document.getElementById("channelId").value;

        fetch(`/api/servers/${channelId}/messages`)  // 여기도 필요에 따라 수정 가능
            .then(res => res.json())
            .then(messages => {
                const list = document.getElementById("messageList");
                list.innerHTML = '';
                messages.forEach(msg => {
                    const li = document.createElement("li");
                    li.innerText = `[${msg.senderName}] ${msg.text}`;
                    list.appendChild(li);
                });
            });
    }

    document.addEventListener("DOMContentLoaded", loadMessages);
</script>

</body>
</html>
