<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>채널 생성</title>
</head>
<body>

<h1>채널 생성</h1>

<form id="channelForm">
  <label>채널 이름:</label><br/>
  <input type="text" id="channelName" name="channelName" required><br/><br/>

  <label>채널 타입:</label><br/>
  <select id="channelType" name="channelType">
    <option value="PUBLIC">PUBLIC</option>
    <option value="PRIVATE">PRIVATE</option>
  </select><br/><br/>

  <button type="submit">생성</button>
</form>

<br/>
<a id="backLink" href="#">← 채널 목록으로 돌아가기</a>

<script>
  // ✅ 파라미터 추출
  function getParams() {
    const params = new URLSearchParams(location.search);
    return {
      serverId: params.get("serverId"),
      token: params.get("token")
    };
  }

  document.addEventListener("DOMContentLoaded", () => {
    const { serverId, token } = getParams();

    if (!serverId || !token) {
      alert("토큰 또는 서버 ID가 누락되었습니다.");
      window.location.href = "/login";
      return;
    }

    // 뒤로가기 링크 설정
    document.getElementById("backLink").href = `/servers/${serverId}/channels?token=${encodeURIComponent(token)}`;

    // 폼 제출 이벤트
    document.getElementById("channelForm").addEventListener("submit", function(event) {
      event.preventDefault();

      const name = document.getElementById("channelName").value;
      const type = document.getElementById("channelType").value;

      fetch(`/api/servers/${serverId}/channels/create`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({
          serverId: serverId,
          name: name,
          type: type
        })
      })
              .then(res => {
                if (!res.ok) throw new Error("채널 생성 실패");
                return res.json();
              })
              .then(data => {
                alert(`채널 생성 완료! ID: ${data}`);
                // window.location.href = `/servers/${serverId}/channels?token=${encodeURIComponent(token)}`;
                window.location.href = `/channels?serverId=${serverId}&token=${encodeURIComponent(token)}`;
              })
              .catch(err => {
                console.error("에러:", err);
                alert("채널 생성에 실패했습니다.");
              });
    });
  });
</script>

</body>
</html>
